/* TidyCMS form */
(function($){var config={handler:null,formName:null,$form:null,tidypath:'tidycms/',before:false,success:false,error:false,};var methods={init:function(options){config=$.extend(config,options);if(this[0].tagName!=='FORM')return $.error('tidyForm - wrong tag type for form.');if(!this.attr('data-tidy-name'))return $.error('tidyForm - missing form attribute data-tidy-name="Name of your form"');if(!this.attr('data-tidy-handler'))return $.error('tidyForm - missing form attribute data-tidy-handler="HANDLERID"');config.$form=this;config.formName=this.attr('data-tidy-name');config.handler=this.attr('data-tidy-handler');config.serverpath=config.tidypath+'server.php?c=forms';methods.pingTidy(function(){config.$form.on('submit',methods.submitForm);});},pingTidy:function(callbackFn){if(typeof window.tidyExists!='undefined'&&window.tidyExists==true){callbackFn();return;}
$.ajax({url:config.serverpath+'&m=tidyExists',data:{hid:config.handler},dataType:'json',cache:false,success:function(){window.tidyExists=true;callbackFn();},error:function(jqXHR,status){$.error("tidyForm - wrong path to tidy, please set tidypath parameter correctly in tidyform options eg. $('#myform').tidyform({ tidypath: '/path/to/tidycms/' })");},});},submitForm:function(e){e.preventDefault();var fdata=config.$form.serializeTidyForm();if(typeof config.before=='function'&&config.before()===false){var bf=config.before(fdata);if(bf===false)return false;if(typeof bf=='object')fdata=bf;}
$.getJSON(config.serverpath+'&m=loadHandler',{hid:config.handler},function(res){if(!res.success&&res.msg=='error.handler.notvalidated')return alert('The handler of this form is not yet validated.');if(!res.success)return $.error(res.msg);if(res.handler.captcha_enabled){var rand=methods.getRandomInt(1000,9999);if(prompt(res.handler.captcha_text1+': '+rand)!=rand)return false;}
var fromEmail=(config.$form.find('[type=email]:first').length>0)?config.$form.find('[type=email]').val():false;$.getJSON(config.serverpath+'&m=sendForm',{hid:config.handler,name:config.formName,form:fdata,ref:window.location.href,fromadr:fromEmail,},function(res){res.data=fdata;if(!res.success){if(typeof config.error=='function')return config.error(res);return false;}
config.$form[0].reset();if(typeof config.success=='function')return config.success(res);return true;});});},getRandomInt:function(min,max){return Math.floor(Math.random()*(max-min+1))+min;},};$.fn.tidyform=function(methodOrOptions){return methods.init.apply(this,arguments);};$.fn.serializeTidyForm=function(){var o={};var a=this.serializeArray();$.each(a,function(){if(o[this.name]!==undefined){if(!o[this.name].push){o[this.name]=[o[this.name]];}
o[this.name].push(this.value||'');}else{o[this.name]=this.value||'';}});return o;};})(jQuery);